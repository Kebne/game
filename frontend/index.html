<!DOCTYPE html>
<html>
<head>
    <title>The sheriff</title>
    <meta charset="UTF-8">
    <meta lang="se-SV">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Bungee|Manrope&display=swap" rel="stylesheet">
    <link href="main.css" rel="stylesheet">
</head>

<body id="sheriff-game">
  <main>
    <section>

      <div class="sheriff-game">
        <div class="sheriff-players-avatars"></div>
        <div class="sheriff-board-pot"></div>
        <div class="sheriff-game-board">
          
          <span class="player-info-rightanswer"></span>
          <div class="sheriff-questions"></div>
        </div>
        
        <div class="sheriff-player-controls">
          <button class="js-player-bet sheriff-button">Betta</button>
          <button class="js-player-pass sheriff-button">Passa</button>
          <button class="js-player-fold sheriff-button">Lägga sig</button>
          <div class="game-slider">
            <label for="playerslider">Att satsa:</label>
            <input id="playerslider" type="range" min="10" max="100" value="10" step="10" class="sheriff-bet-slider">
            <output class="sheriff-bet-slider-output"></output>
          </div>
        </div>

        <div class="sheriff-game-log"></div>

      </div>

    </section>


   
  </main>
</body>



<script type="module">
import {playerBox} from './modules/player.js';
import {questions} from './modules/questions.js';
import {createQuestionForm} from './modules/createquestionform.js';
import {countDown} from './modules/countdown.js';
import {players} from './modules/players.js';
import {controls} from './modules/controls.js';
import {controlsAdmin} from './modules/controls-admin.js';
import {animateMarker} from './modules/animations.js';
import {animateGamePot} from './modules/animations.js';

var currentPlayer = 'player1';
var data = Object.values(players); //this should not be needed anymore
var gamePot = { pot: 0 };
var seatedPlayers = [];
var playersInPlay = [];
var playerProto =  {
   score: 0,
   marks: 900,
   name: 'Han Solo',
   internalName: 'player1',
   seat: 1,
   pass: false,
   bet: [],
   fold: false,
   rightAnswerNr: 0,
   seated: false,
   ready: false,
   playerStatus: 'joining',
 };
 var thePlayers = {};

 // Using proxy for handling events and states
const proxyHandler = {
  set(target, property, value, receiver) {
    //console.log(`target: ${target}, property: ${property}, value: ${value}, receiver: ${receiver},`);
    target[property] = value;
    if (property.localeCompare('marks') == 0) {
      // need also to handle target.name here, also also need refactor so it just makes wich pler does what
      let output = document.querySelector(`.${target.internalName}-info-marks`);
      output.innerHTML = `${value} kr.`;
    };
    if (property.localeCompare('name') == 0) {
      // need also to handle target.name here, also also need refactor so it just makes wich pler does what
      let output = document.querySelector(`.${target.internalName}-info-name`);
      output.innerHTML = `Namn: ${value}.`;
    };
    console.log(`%c Proxy change detected, ${property} is now: ${value}`, 'color: #baaa01')
    return true;
  }
};

var proxyPlayer = new Proxy(players['player1'], proxyHandler);


 // for test
 
let targetElement = document.querySelector('.sheriff-players-avatars');
let testing = Object.keys(players);
testing.forEach(element => {
  let playerBoxWrapper = document.createElement('div');
  playerBoxWrapper.classList.add(element);
  playerBoxWrapper.classList.add('sheriff-player-box-wrapper');
  const theName = document.createElement('div');
  theName.classList.add(`sheriff-avatar-name`);
  theName.textContent = players[element].name; 
  const theImage = document.createElement('img');
  theImage.src= `images/${element}-avatar.png`;
  theImage.classList.add('img-full-width', 'sheriff-avatar-img');
  const theMarks = document.createElement('div');
  theMarks.classList.add(`${element}-info-marks`);
  theMarks.textContent = `${players[element].marks} kr` ;
  theImage.src= `images/${element}-avatar.png`;
  const theStars = document.createElement('div');
  theStars.classList.add('player-info-rightanswer');
  
  playerBoxWrapper.appendChild(theImage);
  playerBoxWrapper.appendChild(theName);
  playerBoxWrapper.appendChild(theMarks);
  playerBoxWrapper.appendChild(theStars);
  targetElement.appendChild(playerBoxWrapper);
});
 //


// Betting
document.querySelector('.sheriff-player-controls').addEventListener('click', function (event) {
  const whichButton = event.target.classList[0];
    
  switch (whichButton) {
    
    case 'js-player-bet':
      console.log('bet');
      playerBets();
      break;
    
    case 'js-player-pass':
      console.log('pass');
      playerPass();
      break;
    
    case 'js-player-fold':
      console.log('fold');
      playerFold();
      break;

    default:
      console.log(`Event target not found`);
  };

});

function playerBets() {
  playSoundFx('betting');
  let sliderValue = Number(slider.value);
  proxyPlayer.bet.unshift(sliderValue);
  proxyPlayer.marks -= slider.value; 
  proxyGamePot.pot += proxyPlayer.bet[0];
  customEvent(`Spelare ${proxyPlayer.name} bettar ${sliderValue}.`, '.js-player-bet');
  theGameLoop.next();
};

function playerPass() {
  playSoundFx('pass');
  customEvent(`Spelare ${proxyPlayer.name} passar.`, '.js-player-pass');
};

function playerFold() { 
  playSoundFx('fold');
  customEvent(`Spelare ${proxyPlayer.name} lägger sig.`, '.js-player-fold');
};
 
// Player betting slider
const slider = document.querySelector('.sheriff-bet-slider');
const output = document.querySelector('.sheriff-bet-slider-output');
output.innerHTML = slider.value;
slider.addEventListener('input', sliderOutput);

function sliderOutput() {
  console.log(`Slider output running ${slider.value}`);
  output.innerHTML = slider.value;
};
//


// Game pot function
const proxyHandlerGamePot = {
  set(target, property, value, receiver) {
  target[property] = value;
  let outputPot = document.querySelector(`.sheriff-board-pot`);
  outputPot.innerHTML = `Spelpotten är ${value}`;
  // So we don't animate before players seated
  if( value != 0 ) { animateGamePot() };
  return true;
  }
};

var proxyGamePot = new Proxy(gamePot ,proxyHandlerGamePot);
proxyGamePot.pot = 0;
//

function createPlayers(name) {
   
   if(playersInPlay.length >= 5) {
     alert('sorry, board is full');
   }
   else {
     playersInPlay.push(name);
     let setPlayerNumber = playersInPlay.length;
     let target = {};
     const currentPlayerToMake = Object.assign(target, playerProto);
     currentPlayerToMake.playerStatus = 'created';
     currentPlayerToMake.internalName = `player${setPlayerNumber}`;
     currentPlayerToMake.name = name;
     thePlayers[`player${setPlayerNumber}`] = currentPlayerToMake;
     console.log('the players', thePlayers);
     return currentPlayerToMake; 
     };
    
   };
   createPlayers('Mr Bond');
   createPlayers('Ms Bond');

// End new code


function playSoundFx(sound = 'start', volume = 1) {
  let audio = new Audio(`sound/${sound}.mp3`);
  audio.volume = volume;
  audio.play();
};


function* gameLoop() {
  yield seating();
  yield firstBet(10); 
  yield askQuestion(1);
  yield askQuestion(2);
  yield betting(0);
  yield askQuestion(3);
  yield askQuestion(4);
  yield betting(1);
  yield endGame();
};
var theGameLoop = gameLoop();
theGameLoop.next();
 

// Custom event, logs game events
document.addEventListener("gameEvent", function(event) {
  let time = new Date(); 
  let timeMin = time.getMinutes();
  let timeSec = time.getSeconds();
  document.querySelector('.sheriff-game-log').insertAdjacentHTML('afterbegin', `${timeMin}:${timeSec} - ${event.detail}<br><br>`);
});

// Helper function for Custom events
function customEvent(message, dispatchFrom) {
  const custElement = new CustomEvent("gameEvent", {detail: message, bubbles: true, cancelable: true });
  document.querySelector(`${dispatchFrom}`).dispatchEvent(custElement);
};

//To highlight current player 
let highlight = document.querySelector(`.${currentPlayer}`);
highlight.classList.add('current-player-highlight');







function seating() {
  console.log(`%c Seating now running`, 'font-weight: 700');
  setTimeout(()=>theGameLoop.next(),4000);
};


function firstBet(autoBetSum = 10) {
  console.log('%c Firstbet now running', 'font-weight: 700');
  proxyPlayer.marks -= autoBetSum;
  proxyGamePot.pot += autoBetSum;
  setTimeout(()=>theGameLoop.next(),8000);
};


function askQuestion(nr) {
  console.log(`%c Question ${nr} now running`, 'font-weight: 700');
  let currentQuestion = questions[`question${nr}`];
  document.querySelector('.sheriff-questions').classList.remove('game-hide');
  countDown(5, currentQuestion, theGameLoop);
  playSoundFx('question', 0.1);
  createQuestionForm(currentQuestion);

  document.querySelector('#game-question-button1').addEventListener('click', questionAnswerCheck);
  document.querySelector('#game-question-button2').addEventListener('click', questionAnswerCheck);
  document.querySelector('#game-question-button3').addEventListener('click', questionAnswerCheck);
  document.querySelector('#game-question-button4').addEventListener('click', questionAnswerCheck);

  function questionAnswerCheck(event) {
    playSoundFx('start');
    let content = event.target.innerHTML;
    let correct = currentQuestion.correctAnswer;
    console.log(`clicked button text: ${content}, correct answer: ${correct}`);
    if (!content.localeCompare(correct)) {  // localCompare returns 0 if the two strings are equal.
      proxyPlayer.rightAnswerNr++;
      let correctOutput = document.querySelector(`.player-info-rightanswer`);
      let starImage = document.createElement('img');
      starImage.src = 'images/star.png';
      starImage.className = 'img-correct-answer';
      starImage.alt = 'star icon'
      correctOutput.append(starImage);
    }
    else {
      let correctOutput = document.querySelector(`.player-info-rightanswer`);
      let starImage = document.createElement('img');
      starImage.src = 'images/star-grey.png';
      starImage.classList.add('img-wrong-answer');
      starImage.alt = 'star icon wrong'
      correctOutput.append(starImage);
    }
    customEvent(`Spelare ${proxyPlayer.name}  svarade: ${content}`, '#game-question-button1');
  };

};


function betting(turn) {
  console.log(`%c Betting round ${turn} now running`, 'font-weight: 700');
  // p1 code
  if(turn==1){setTimeout(()=>theGameLoop.next(),6000);};
  document.querySelector('.sheriff-questions').classList.add('game-hide');
  
  

  let bet = document.querySelector('.js-player-bet');
  bet.removeAttribute('disabled');

  let pass = document.querySelector('.js-player-pass');
  pass.removeAttribute('disabled')
  
  let fold = document.querySelector('.js-player-fold');
  fold.removeAttribute('disabled');

  // playerSimulateBet, for testing purpose, remove in production
  function playerSimulateBet() {
      proxyPlayer = 'proxyplayer2'; //fix this line
      proxyPlayer.bet.unshift(100);
      proxyPlayer.marks -= 100; 
      proxyGamePot.pot += proxyPlayer.bet[0];
      customEvent(`Spelare ${proxyPlayer.name} bettar 100`, '.js-player-bet');
      proxyPlayer = proxyplayer1;
    }
    //playerSimulateBet();

  function checkPlayersRemaining() {
    const result = data.filter(player => player.fold == false);
    const finalResult = result.length ? 'keep going' : 'Game over man, game over!'; 
    console.log(`Players remaining ${result.length}, ${finalResult}`);
    return result;
  };
  const playersRemain = checkPlayersRemaining();


  function markIconToggle() {
    // Maybe not the best way to show the graphical mark but it works, feel free to refactor this
    let getHiddenClass = document.querySelector(`.${proxyPlayer.internalName} .mark-wrapper-display-none`);
    getHiddenClass.classList.toggle('mark-wrapper-display-none');
  /* old code
    let getHiddenClass = document.querySelectorAll('.mark-wrapper-display-none');
  getHiddenClass.forEach(item => item.classList.toggle('mark-wrapper-display-none'));*/
  };

  // Game rules logic, work in progress
  if (playersRemain.legth = 1) {
    //Player thats in playersRemain winns
    const sumToWinner = proxyGamePot.pot;
    proxyPlayer.marks += sumToWinner;
    proxyGamePot.pot = 0;
  };

 
  
  function playerBets() {
    animateMarker(currentPlayer); 
    playSoundFx('betting');
    let sliderValue = Number(slider.value);
    console.log('slidervalue when betted: ', sliderValue);
    proxyPlayer.bet.unshift(sliderValue);
    proxyPlayer.marks -= slider.value; 
    proxyGamePot.pot += proxyPlayer.bet[0];
    // mockup code, player 2 shouldt be hardcoded
    proxyPlayer2.marks -= 50; 
    proxyGamePot.pot += 50;
    customEvent(`Spelare ${proxyPlayer.name} bettar ${sliderValue}`, '.js-player-bet');
     // p1 code
    setTimeout(()=>theGameLoop.next(),6000);
  };

  function playerPass() {
    playSoundFx('pass');
    proxyPlayer.pass = true;
    customEvent(`Spelare ${proxyPlayer.name} passar ${proxyPlayer.pass}`, '.js-player-pass');

    proxyPlayer2.pass = true;
    if(proxyPlayer.pass == true && proxyPlayer2.pass == true) {
      console.log('Both players pass, getting new questions');
      proxyPlayer.pass = false;
      proxyPlayer2.pass = false;
      bettingElement.classList.add('game-hide');
      theGameLoop.next();
    };

  };

  function playerFold() { 
    playSoundFx('fold');
    proxyPlayer.fold = true;
    customEvent(`Spelare ${proxyPlayer.name} lägger sig ${proxyPlayer.fold}`, '.js-player-fold');
    const playersLeftAfterFold = checkPlayersRemaining();
    
    if(playersLeftAfterFold.length == 0) {
      bettingElement.classList.add('game-hide');
      theGameLoop.done = true;
      endGame();
    };

  };
 
  // Player betting slider
  const slider = document.querySelector('.sheriff-bet-slider');
  const output = document.querySelector('.sheriff-bet-slider-output');
  output.innerHTML = slider.value;
  slider.addEventListener('input', sliderOutput);
  
  function sliderOutput() {
    console.log(`Slider output running ${slider.value}`);
    output.innerHTML = slider.value;
  };
  //
};




function endGame() {
  console.log(`%c End game now running`, 'font-weight: 700');
  console.log(`Spelare Har nu ${proxyPlayer.marks}`);
  const sumToWinner = proxyGamePot.pot;
  proxyPlayer.marks += sumToWinner;
  proxyGamePot.pot = 0;
  animateGamePot();

  console.log(`Spelare ${proxyPlayer.name} vann! Har nu ${proxyPlayer.marks}, proxyGamePot: ${proxyGamePot.pot}, sumToWinner: ${sumToWinner}`);
  /*let p1 = currentPlayerPath.bet; 
  let p1b = p1.reduce((a,b)=>a+b);
  let p2 = [400, 200];
  let p2b = p2.reduce((a,b)=>a+b);*/
};


</script>
</html>
