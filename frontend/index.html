<!DOCTYPE html>
<html>
<head>
    <title>The sheriff</title>
    <meta charset="UTF-8">
    <meta lang="se-SV">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Bungee|Manrope&display=swap" rel="stylesheet">
    <link href="main.css" rel="stylesheet">
</head>


<body id="sheriff-game">
  
  <main>
    <div>

    <section>
      <div class="game-overlay-wrapper">
        <div class="game-overlay">
          <div class="game-overlay-flex">
            <div class="game-overlay-button-wrapper"><button class="game-start-button">Start</button></div>
          </div>
        </div>
      </div>
    </section>

    <section>
      <div class="game-questions"></div>
    </section>

    <section>
      <div class="game-countdown"></div>
      <div class="game-wait"></div>
      <div class="game-correct-answer"></div>
    </section>

    <section>
      <div class="game-board-wrapper">
        <game-board></game-board>
      </div>
    </section>

    <section>
      <div class="player-input-wrapper">  
        <div>
          <div class="player-marks"></div>
          <div class="player-status"></div>
          
          <div class="game-slider">
            <label for="playerslider">Att satsa:</label>
            <input id="playerslider" type="range" min="10" max="100" value="10" step="10" class="bet-slider">
            <output class="bet-slider-output"></output>
          </div>
          <div class="player-input">  
              <div><button class="js-player-bet player-input-button">Betta</button></div>
              <div><button class="js-player-pass player-input-button">Passa</button></div>
              <div><button class="js-player-fold player-input-button">Lägga sig</button></div>
          </div>
        </div> 
        
          <div>
            <div class="player-switch">
              <i>Detta är endast till för testning, detta är inte en del av spelet</i><br>
              <label for="player-switch-select">Välj spelare:</label>
              <select class="player-switch-select">
                <!--options in here dynamical -->
              </select>
            </div>
          </div>
        
      </div> 
    </section>

    
  </div>
  </main>
</body>


<script type="module">

import {questions} from './modules/questions.js';
import {createQuestionForm} from './modules/createquestionform.js';
import {countDown} from './modules/countdown.js';
import {playerChoice} from './modules/playerchoice.js';
import {players} from './modules/players.js';
import {createGameBoard} from './modules/gameboard.js';
  
 
window.onload = game();

//for start screen
/* document.querySelector('.game-overlay-button-wrapper').addEventListener('click', function () {
  document.querySelector('.game-overlay-wrapper').innerHTML ="";
  game();
  }); */

  
async function game() {
  var data = Object.values(players);
  var gamePot = 0;
  var currentPlayer = 'player1';
  var currentPlayerNr = 1;
  var currentPlayerPath = data[0];
  var seatedPlayers = ['player1','player2']; // not in use right now
  
  document.querySelector('.player-marks').innerHTML = `Spelare marker: ${currentPlayerPath.marks}`;
  document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerPath.pass}</i>, Lägga sig <i>${currentPlayerPath.fold}</i>`;
 
  /*let audio = new Audio('sound/background-sound.mp3');
  audio.volume = 0.1;
  audio.loop = true;
  audio.play();*/
  
  createGameBoard(data);
  togglingCurrentPlayer(players);
  document.querySelector('.board').innerHTML =  `Potten är: ${gamePot}`;
  
  //To highlight current player 
  let highlight = document.querySelector(`.${currentPlayer}`);
  highlight.classList.add('current-player-highlight');


  // Remove this function in production, used for testing diffrent players actions.
  function togglingCurrentPlayer(data) {
    console.log('t data', data)
    var selectElement = document.querySelector('.player-switch-select');
    const dataToSelect = Object.keys(data);
    console.log('obj',dataToSelect);
    
    dataToSelect.forEach((item) => {
        console.log('item', item);
        const optionElement = document.createElement('option');
        optionElement.value = item;
        optionElement.text = item;
        selectElement.appendChild(optionElement);
    });
   
    selectElement.addEventListener('change', function() {
      let choosenPlayer = selectElement.options[selectElement.selectedIndex].value;
      let highlight = document.querySelector(`.${currentPlayer}`);
      highlight.classList.remove('current-player-highlight');
      currentPlayer = choosenPlayer;
      console.log('current player after chose',currentPlayer);
      let highlight2 = document.querySelector(`.${currentPlayer}`);
      highlight2.classList.add('current-player-highlight');
      console.log('currentPlayer', currentPlayer);
    });
   
  };
  //

  // Player Betting
  document.querySelector('.js-player-bet').addEventListener('click', function () {
    let audioBetting = new Audio('sound/betting.mp3');
    animateMarker(currentPlayer);
    audioBetting.play();
    currentPlayerPath.bet.unshift(Number(slider.value));
    currentPlayerPath.marks -= slider.value;
    gamePot += currentPlayerPath.bet[0];
    document.querySelector('.player-marks').innerHTML = `Spelare marker: ${currentPlayerPath.marks}`; 
    document.querySelector('.board').innerHTML =  `Potten är: ${gamePot}`;
    document.querySelector(`.${currentPlayer}-info-marks`).innerHTML =  `Marker: ${currentPlayerPath.marks}<br>`
  });
  //

  // Player Passing
  document.querySelector('.js-player-pass').addEventListener('click', function () {
    let audioPass = new Audio('sound/pass.mp3');
    audioPass.play();
    data[0].pass = true;
    document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerPath.pass}</i>, Lägga sig <i>${currentPlayerPath.fold}</i>`;
  });
  //

  // Player Fold
  document.querySelector('.js-player-fold').addEventListener('click', function () {
    let audioFold = new Audio('sound/fold.mp3');
    audioFold.play();
    currentPlayerPath.fold = true;
    document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerPath.pass}</i>, Lägga sig <i>${currentPlayerPath.fold}</i>`;
  });
  //

  // Player betting slider
  const slider = document.querySelector('.bet-slider');
  const output = document.querySelector('.bet-slider-output');
  output.innerHTML = slider.value;
  slider.addEventListener('input', sliderOutput);
  
  function sliderOutput() {
    console.log('slideroutput running');
    output.innerHTML = slider.value;
    document.querySelector('.player-marks').innerHTML = `Spelare marker: ${currentPlayerPath.marks}`; 
  };
  //

  // Mark animation
  const animationMark = [
{ 
  transform: 'translateX(1px) rotate(4deg)', 
  transformOrigin: 'center', 
  filter: 'blur(8px)', 
  opacity: 0.6 
  },
  { 
    transform: 'translateX(300px) rotate(360deg)',
    transformOrigin: 'center',
    filter: 'blur(0)',
    opacity: 1 
  }
];

const animationMarkRightSide = [
{ 
  transform: 'translateX(1px) rotate(4deg)', 
  transformOrigin: 'center', 
  filter: 'blur(8px)', 
  opacity: 0.6 
  },
  { 
    transform: 'translateX(-300px) rotate(360deg)',
    transformOrigin: 'center',
    filter: 'blur(0)',
    opacity: 1 
  }
];

const animationMarkDownSide = [
{ 
  transform: 'translateY(1px) rotate(4deg)', 
  transformOrigin: 'center', 
  filter: 'blur(8px)', 
  opacity: 0.6 
  },
  { 
    transform: 'translateY(-300px) rotate(360deg)',
    transformOrigin: 'center',
    filter: 'blur(0)',
    opacity: 1 
  }
];



const optionsMark = {
  iterations: 1,
  iterationStart: 0,
  delay: 0,
  endDelay: 0,
  duration: 700,
  fill: 'forwards',
  easing: 'ease-out',
}

function animateMarker(currentPlayer) {
  console.log('animate current player: ', currentPlayer);
  switch (currentPlayer) {
  case 'player1':
  case 'player2':
    let element  = document.querySelector(`.img-mark-${currentPlayer}`);
    element.animate(animationMark,optionsMark)
    /*console.log('element', element);
    let target = element.cloneNode(true);
    console.log('target', target);
    let targetElement = document.querySelector(`.mark-${currentPlayer}`);
    targetElement.prepend(target); 
    target.animate(animationMark,optionsMark);*/
    
    break;
  case 'player3':
  case 'player4':
    document.querySelector(`.img-mark-${currentPlayer}`).animate (animationMarkRightSide,optionsMark);
    break;
  case 'player5':
    document.querySelector(`.img-mark-${currentPlayer}`).animate (animationMarkDownSide,optionsMark);
    break;
  default:
    console.log('Sorry, no player mark found');
}

  //let target = currentPlayer;
  
};
//
 
 // Main game logic
  await seating(data);
  await firstBet(data, gamePot); // this "betting" is handle by system not players
  await askQuestion(1);
  await wait();
  await askQuestion(2);
  await betting(0);
  await askQuestion(3);
  await wait();
  await askQuestion(4);
  await betting(1);
  await endGame(currentPlayerPath);
};
//

// According to spec players need pay 50 coins before seated, todo: make this funtion here.

async function seating(data) {
  return new Promise((resolve) => { //maybe dont need to return this, todo: look it up.
    data.forEach((item) => {
      item.seated = true;
    });
    resolve();
  });
};


async function firstBet(data, gamePot) {
  return new Promise((resolve) => {
    data.forEach((item) => {
        item.marks -= 10;
        gamePot += 10;
        item.bet.push(10);
        console.log('Marks after first bet: ', item.marks);
    });
    document.querySelector(`.player1-info-marks`).innerHTML = `Marker: ${data[0].marks}<br>`;
    document.querySelector(`.player2-info-marks`).innerHTML = `Marker: ${data[1].marks}<br>`;
    document.querySelector(`.player3-info-marks`).innerHTML = `Marker: ${data[2].marks}<br>`;
    document.querySelector(`.player4-info-marks`).innerHTML = `Marker: ${data[3].marks}<br>`;
    document.querySelector(`.player4-info-marks`).innerHTML = `Marker: ${data[4].marks}<br>`;
    document.querySelector('.board').innerHTML =  `Potten är: ${gamePot}`;
    
    resolve();
  }); 
};


async function askQuestion(nr) {
  let currentQuestion = questions[`question${nr}`];
  return new Promise((resolve) => {
    console.log('currentQuestion', currentQuestion);
    countDown(3, currentQuestion, () => resolve()); 
    let questionSound = new Audio('sound/question.mp3');
    questionSound.volume = 0.1;
    questionSound.play();
    createQuestionForm(currentQuestion);
    
  });
  
};


function timeout(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
async function wait()
{
    document.querySelector('.game-wait').innerHTML = 'Snart kommer en ny fråga ...';
    await timeout(3000);
    document.querySelector('.game-wait').innerHTML = '';
}


async function betting(turn, currentPlayer) {
  return new Promise((resolve) => {
    let p1 = 100;
    let p2 = 200;
    resolve();
  });
};


async function endGame(currentPlayerPath) {
  return new Promise((resolve) => {

    let p1 = currentPlayerPath.bet; 
    let p1b = p1.reduce((a,b)=>a+b);
    let p2 = [400, 200];
    let p2b = p2.reduce((a,b)=>a+b);
  
    resolve();
  });
};




</script>

</html>
