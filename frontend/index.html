<!DOCTYPE html>
<html>
<head>
    <title>The sheriff</title>
    <meta charset="UTF-8">
    <meta lang="se-SV">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Bungee|Manrope&display=swap" rel="stylesheet">
    <link href="main.css" rel="stylesheet">
</head>

<body id="sheriff-game">
  <main>
    <div class="main-game-grid">
        <div class="game-log"></div>
        <div class="game-board-wrapper">
          <div class="game-board">
            <div class="player1"><img class="img-full-width" id="player1" src="images/empty-chair.png"></div>
            <div class="game-questions game-hide"></div>
            <div class="game-betting game-hide"></div>
            <div class="board"><span class="board-pot"></span></div>
            <div class="player4"><img class="img-full-width" id="player4" src="images/empty-chair.png"></div>
            <div class="player2"><img class="img-full-width" id="player2" src="images/empty-chair.png"></div>
            <div class="player3"><img class="img-full-width" id="player3" src="images/empty-chair.png"></div>
            <div class="player5"><img class="img-full-width" id="player5" src="images/empty-chair.png"></div>
          </div>
      </div>
        <player-controls class="player-input-wrapper"></player-controls>
      </div>
  </main>
</body>

<script type="module">
import {playerBox} from './modules/player.js';
import {questions} from './modules/questions.js';
import {createQuestionForm} from './modules/createquestionform.js';
import {countDown} from './modules/countdown.js';
import {players} from './modules/players.js';
import {controls} from './modules/controls.js';
import {animateMarker} from './modules/animations.js';


// Using proxy for handling events and states
const proxyHandler = {
  set(target, property, value, receiver) {
    target[property] = value;
    if (property.localeCompare('marks') == 0) {
      let output = document.querySelector(`.${currentPlayer}-info-marks`);
      let outputCtrlPanel = document.querySelector('.player-marks');
      output.innerHTML = `Marker proxy ${value}`; 
      outputCtrlPanel .innerHTML = `Spelare marker: ${value}`;
      console.log('output proxy', output);
    };
    console.log(`%c Proxy change detected, ${property} is now: ${value}`, 'color: #baaa01')
    return true;
  }
};

const proxyHandlerGamePot = {
  set(target, property, value, receiver) {
  console.log('proxy gamepot running');
  target[property] = value;
  let outputPot = document.querySelector(`.board-pot`);
  console.log('outputPot', outputPot);
  outputPot.innerHTML = `Spelpotten är ${value}`;
  return true;
  }
};

var proxyplayer1 = new Proxy(players.player1, proxyHandler);
var proxyplayer2 = new Proxy(players.player2, proxyHandler);
var proxyplayer3 = new Proxy(players.player3, proxyHandler);
var proxyplayer4 = new Proxy(players.player4, proxyHandler);
var proxyplayer5 = new Proxy(players.player5, proxyHandler);




var currentPlayer = 'player1';
var currentPlayerProxy = proxyplayer1;
var data = Object.values(players);
var gamePot = { pot: 0 };
var seatedPlayers = []; // not in use right now, maybe implement as async await player1, player2 etc

var proxyGamePot = new Proxy(gamePot ,proxyHandlerGamePot);
gamePot.pot = 0;
// This is needed to be globally function se we can reapply event listner when players left
function createPlayer() { 
    let wichPlayer = event.target.id;
    let playerNr = String(wichPlayer);
    playSoundFx('seated');

    // This switches wich proxy to go to.
    if (playerNr.localeCompare('player1') == 0) {
      currentPlayerProxy = proxyplayer1
    };
    if (playerNr.localeCompare('player2') == 0) {
      currentPlayerProxy = proxyplayer2
    };
    if (playerNr.localeCompare('player3') == 0) {
      currentPlayerProxy = proxyplayer3
    };
    if (playerNr.localeCompare('player4') == 0) {
      currentPlayerProxy = proxyplayer4;
    };
    if (playerNr.localeCompare('player5') == 0) {
      currentPlayerProxy = proxyplayer5;
    };

    currentPlayerProxy.seated = true;
    console.log('%c Player seated: ','color: #156b26', currentPlayerProxy);
    seatedPlayers.push(playerNr); //maybe alter this
    let element1 = document.querySelector(`.${playerNr}`);
    element1.innerHTML = `<player-box player="${playerNr}"></player-box>`;
    document.querySelector(`.${playerNr}-info-name`).innerHTML = `Namn: ${currentPlayerProxy.name}`;
    document.querySelector(`.${playerNr}-info-marks`).innerHTML = `Marker: ${currentPlayerProxy.marks}`;
};


function playSoundFx(sound = 'start', volume = 1) {
  let audio = new Audio(`sound/${sound}.mp3`);
  audio.volume = volume;
  audio.play();
}


function* gameLoop() {
  yield seating();
  yield firstBet(); 
  yield askQuestion(1);
  yield askQuestion(2);
  yield betting(0);
  yield askQuestion(3);
  yield askQuestion(4);
  yield betting(1);
};
var theGameLoop = gameLoop();
theGameLoop.next();
 

// Custom event, logs game events
document.addEventListener("gameEvent", function(event) {
  let time = new Date(); 
  let timeMin = time.getMinutes();
  let timeSec = time.getSeconds();
  document.querySelector('.game-log').insertAdjacentHTML('afterbegin', `${timeMin}:${timeSec} - ${event.detail}<br>`);
});


const playerLeaveElement = document.querySelector('.game-board');
document.addEventListener('click', function() {
  let whatElement = event.target;
  let getString = whatElement.className;
  let playerToSelectForLeaving = getString.replace('-leave', '');
  
  if(whatElement.nodeName == 'BUTTON' && whatElement.innerText == 'Lämna') {
    const imgElement = document.createElement("img");
    imgElement.src = 'images/empty-chair.png';
    imgElement.id = playerToSelectForLeaving;
    imgElement.className = 'img-full-width';
    imgElement.addEventListener('click', createPlayer);
    document.querySelector(`.${playerToSelectForLeaving}`).innerHTML = '';
    document.querySelector(`.${playerToSelectForLeaving}`).appendChild(imgElement);
  };
  
});

document.querySelector('.player-marks').innerHTML = `Spelare marker: ${currentPlayerProxy.marks}`;
document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerProxy.pass}</i>, Lägga sig <i>${players[currentPlayer].fold}</i>`;
  
togglingCurrentPlayer(players);

//To highlight current player 
let highlight = document.querySelector(`.${currentPlayer}`);
highlight.classList.add('current-player-highlight');


// You can remove this function in production, used for testing diffrent players actions.
function togglingCurrentPlayer(data) {
  
  var selectElement = document.querySelector('.player-switch-select');
  const dataToSelect = Object.keys(data);
  
  dataToSelect.forEach((item) => {
      const optionElement = document.createElement('option');
      optionElement.value = item;
      optionElement.text = item;
      selectElement.appendChild(optionElement);
  });
  
  selectElement.addEventListener('change', function() {
    let choosenPlayer = selectElement.options[selectElement.selectedIndex].value;
    let highlight = document.querySelector(`.${currentPlayer}`);
    highlight.classList.remove('current-player-highlight');
    
    // This so we also switch to correct proxy
    if (choosenPlayer.localeCompare('player1') == 0) {
      currentPlayerProxy = proxyplayer1
    };
    if (choosenPlayer.localeCompare('player2') == 0) {
      currentPlayerProxy = proxyplayer2
    };
    if (choosenPlayer.localeCompare('player3') == 0) {
      currentPlayerProxy = proxyplayer3
    };
    if (choosenPlayer.localeCompare('player4') == 0) {
      currentPlayerProxy = proxyplayer4;
    };
    if (choosenPlayer.localeCompare('player5') == 0) {
      currentPlayerProxy = proxyplayer5;
    };
      
    currentPlayer = choosenPlayer;
    
    let highlight2 = document.querySelector(`.${currentPlayer}`);
    highlight2.classList.add('current-player-highlight');
    console.log('%c Current proxy player is now: ', 'color: #1a329b', currentPlayerProxy);
    console.log('%c CurrentPlayer is now:', 'color: #1a329b', currentPlayer);
  });
  
};
//

 
// Admin activate question
const getQButton = document.querySelector('.question-button');
const getQNr = document.querySelector('#get-question-nr');
getQButton.addEventListener('click', function() {
  askQuestion(getQNr.value);
});
//


function seating() {
  console.log(`%c Seating now running`, 'font-weight: 700');
  document.querySelector('#player1').addEventListener('click', createPlayer);
  document.querySelector('#player2').addEventListener('click', createPlayer);
  document.querySelector('#player3').addEventListener('click', createPlayer);
  document.querySelector('#player4').addEventListener('click', createPlayer);
  document.querySelector('#player5').addEventListener('click', createPlayer);
  
  document.querySelector('.js-player-ready').addEventListener('click', function () {
    playSoundFx('start');
    currentPlayerProxy.ready = true; //Todo, make sure this actully works
   

    let customEvent = new CustomEvent("gameEvent", {detail: `Spelare ${ currentPlayerProxy.name} redo`, bubbles: true, cancelable: true });
    document.querySelector('.js-player-ready').dispatchEvent(customEvent);

    theGameLoop.next();
    });
 };


function firstBet() {
  console.log('%c Firstbet now running', 'font-weight: 700');
  data.forEach((item) => {
        item.marks -= 10;
        proxyGamePot.pot += 10;
        item.bet.push(10);
    });
    
    seatedPlayers.forEach((item) => {
      let playerMark = players[item]['marks'];
      document.querySelector(`.${item}-info-marks`).innerHTML = `Marker: ${playerMark}`;   
    });

    let customEvent = new CustomEvent("gameEvent", {detail: `Alla spelare har gjort första bettet`, bubbles: true, cancelable: true });
    document.querySelector('.js-player-ready').dispatchEvent(customEvent);
    document.querySelector('.js-player-ready-q').addEventListener('click', function () {
      playSoundFx('start');
      theGameLoop.next();
    }); 
};


function askQuestion(nr) {
  console.log(`%c Question ${nr} now running`, 'font-weight: 700');
  let currentQuestion = questions[`question${nr}`];
  document.querySelector('.game-questions').classList.remove('game-hide');
  countDown(2, currentQuestion, theGameLoop);
  playSoundFx('question', 0.1);
  createQuestionForm(currentQuestion);

  document.querySelector('#game-question-button1').addEventListener('click', questionAnswerCheck);
  document.querySelector('#game-question-button2').addEventListener('click', questionAnswerCheck);
  document.querySelector('#game-question-button3').addEventListener('click', questionAnswerCheck);

  function questionAnswerCheck(event) {
    playSoundFx('start');
    let content = event.target.innerHTML;
    let correct = currentQuestion.correctAnswer;
    if (!content.localeCompare(correct)) {  // localCompare returns 0 if the two strings are equal.
      console.log('Players anser is correct!');
      currentPlayerProxy.rightAnswerNr++;
      let correctOutput = document.querySelector(`.${currentPlayer}-info-rightanswer`);
      correctOutput.innerText = `Antal rätt svar: ${currentPlayerProxy.rightAnswerNr}`;
    };
    let customEvent = new CustomEvent("gameEvent", {detail: `Spelare ${currentPlayerProxy.name}  svarade: ${content}`, bubbles: true, cancelable: true });
    document.querySelector('#game-question-button1').dispatchEvent(customEvent); 
  };

};


function betting(turn) {
  console.log(`%c Betting round ${turn} now running`, 'font-weight: 700');
  document.querySelector('.game-questions').classList.add('game-hide');
  let bettingElement = document.querySelector('.game-betting');
  bettingElement.classList.remove('game-hide');
  bettingElement.innerText = 'Dags att betta';

  let bet = document.querySelector('.js-player-bet');
  bet.removeAttribute('disabled');

  let pass = document.querySelector('.js-player-pass');
  pass.removeAttribute('disabled')
  
  let fold = document.querySelector('.js-player-fold');
  fold.removeAttribute('disabled');

  function checkPlayersRemaining() {
    const result = data.filter(player => player.fold == false);
    const finalResult = result.length ? 'keep going' : 'Game over man, game over!'; 
    console.log(`Players remaining ${result.length}, ${finalResult}`);
    return result;
  };
  const playersRemain = checkPlayersRemaining();
  console.log('playersRemain: ', playersRemain);

   // Maybe not the best way to show the graphical mark but it works, feel free to refactor this
   let getHiddenClass = document.querySelectorAll('.mark-wrapper-display-none');
    getHiddenClass.forEach(item => item.classList.toggle('mark-wrapper-display-none'));
  
 
  // Player Betting
  document.querySelector('.js-player-bet').addEventListener('click', function () {
  animateMarker(currentPlayer);
  playSoundFx('betting');
  let sliderValue = Number(slider.value);
  currentPlayerProxy.bet.unshift(sliderValue);
  currentPlayerProxy.marks -= slider.value;
  proxyGamePot += currentPlayerProxy.bet[0];
  
  let customEvent = new CustomEvent("gameEvent", {detail: `Spelare ${currentPlayerProxy.name} bettar ${sliderValue}`, bubbles: true, cancelable: true });
  document.querySelector('.js-player-bet').dispatchEvent(customEvent);
  });
  //


  // Player betting slider
  const slider = document.querySelector('.bet-slider');
  const output = document.querySelector('.bet-slider-output');
  output.innerHTML = slider.value;
  slider.addEventListener('input', sliderOutput);
  
  function sliderOutput() {
    console.log('slideroutput running');
    output.innerHTML = slider.value;
    document.querySelector('.player-marks').innerHTML = `Spelare marker: ${currentPlayerProxy.marks}`; 
  };
  //


  // Player Passing
  document.querySelector('.js-player-pass').addEventListener('click', function () {
    playSoundFx('pass');
    currentPlayerProxy.pass = true;

     let customEvent = new CustomEvent(
       "gameEvent", {
         detail: `Spelare ${currentPlayerProxy.name} passar ${currentPlayerProxy.pass}`, bubbles: true, cancelable: true 
      });
      document.querySelector('.js-player-bet').dispatchEvent(customEvent);

    document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerProxy.pass}</i>, Lägga sig <i>${currentPlayerProxy.pass}</i>`;

    if(proxyplayer1.pass == true && proxyplayer2.pass == true) {
      console.log('Both players pass, getting new questions');
      proxyplayer1.pass = false;
      proxyplayer2.pass = false;
      bettingElement.classList.add('game-hide');
      theGameLoop.next();
    };


  });
  //


  // Player Fold
  document.querySelector('.js-player-fold').addEventListener('click', function () {
    playSoundFx('fold');
    currentPlayerProxy.fold = true;

    let customEvent = new CustomEvent("gameEvent", {detail: `Spelare ${currentPlayerProxy.name} lägger sig ${currentPlayerProxy.fold}`, bubbles: true, cancelable: true });
    document.querySelector('.js-player-bet').dispatchEvent(customEvent);

    document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerProxy.pass}</i>, Lägga sig <i>${currentPlayerProxy.fold}</i>`;

    const playersLeftAfterFold = checkPlayersRemaining();
    console.log('playersLeftAfterFold',playersLeftAfterFold);
    if(playersLeftAfterFold.length == 0) {
      bettingElement.classList.add('game-hide');
      theGameLoop.done = true;
      endGame();
    };

  });
  //


  document.querySelector('.js-player-ready-betting-done').addEventListener('click', function () {
    playSoundFx('start');
    theGameLoop.next();
  });

};


function endGame() {
  console.log(`%c End game now running`, 'font-weight: 700');
   
    /*let p1 = currentPlayerPath.bet; 
    let p1b = p1.reduce((a,b)=>a+b);
    let p2 = [400, 200];
    let p2b = p2.reduce((a,b)=>a+b);*/
    
};


</script>
</html>
