<!DOCTYPE html>
<html>
<head>
    <title>The sheriff</title>
    <meta charset="UTF-8">
    <meta lang="se-SV">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Bungee|Manrope&display=swap" rel="stylesheet">
    <link href="main.css" rel="stylesheet">
</head>


<body id="sheriff-game">
  <main>
    <div class="main-game-grid">
        <div class="game-log"></div>
        <div class="game-board-wrapper">
          <div class="game-board">
            <div class="player1"><img id="player1" src="images/empty-chair.png"></div>
            <div class="game-questions"></div>
            <div class="board"></div>
            <div class="player4"><img id="player4" src="images/empty-chair.png"></div>
            <div class="player2"><img id="player2" src="images/empty-chair.png"></div>
            <div class="player3"><img id="player3" src="images/empty-chair.png"></div>
            <div class="player5"><img id="player5" src="images/empty-chair.png"></div>
          </div>
      </div>
        <player-controls class="player-input-wrapper"></player-controls>
      </div>
  </main>
</body>


<script type="module">
import {playerBox} from './modules/player.js';
import {questions} from './modules/questions.js';
import {createQuestionForm} from './modules/createquestionform.js';
import {countDown} from './modules/countdown.js';
import {playerChoice} from './modules/playerchoice.js';
import {players} from './modules/players.js';
import {controls} from './modules/controls.js';

var currentPlayer = 'player2';
var data = Object.values(players);
var gamePot = 0;
var currentPlayerNr = 1;
var currentPlayerPath = data[0];
var seatedPlayers = ['player1','player2']; // not in use right now, maybe implement as async await player1, player2 etc
var allSeated = false;

const playerProto = {
   marks: 1000,
   name: 'John Doe',
   seat: 1,
   pass: false,
   bet: [],
   fold: false,
   answers: [],
   rightAnswerNr: 0,
   seated: false,
 };

window.onload = game();
async function game() {
  // Custom event, logs game events
  document.addEventListener("gameEvent", function(event) {
    let time = new Date(); 
    let timeMin = time.getMinutes();
    let timeSec = time.getSeconds();
    //time.toLocaleDateString();
    document.querySelector('.game-log').insertAdjacentHTML('afterbegin', `${timeMin}:${timeSec} - ${event.detail}<br>`);
  });

  // Seating logic
  document.querySelector('.game-board').addEventListener('click', function(event) {
      let wichPlayers = event.target.id;
      console.log('t event', event.target);
      let playerNr = String(wichPlayers);
      switch (playerNr) {
        case 'player1' : 
            window.player1 = Object.create(playerProto);
            player1.name = playerNr;
            player1.seated = true;
            let element1 = document.querySelector(`.${playerNr}`);
            element1.innerHTML = '<player-box style="display: flex;" player="player1"></player-box>';
            console.log('player1', player1);
          break;
          case 'player2' : 
            window.player2 = Object.create(playerProto);
            player2.name = playerNr;
            player2.seated = true;
            let element2 = document.querySelector(`.${playerNr}`);
            element2.innerHTML = '<player-box style="display: flex;" player="player2"></player-box>';
            console.log('player2', player2);
          break;
          case 'player3' : 
            window.player3 = Object.create(playerProto);
            player3.name = playerNr;
            player3.seated = true;
            let element3 = document.querySelector(`.${playerNr}`);
            element3.innerHTML = '<player-box style="display: flex;" player="player3"></player-box>';
            console.log('player3', player3);
          break;
          case 'player4' : 
            window.player4 = Object.create(playerProto);
            player4.name = playerNr;
            player4.seated = true;
            let element4 = document.querySelector(`.${playerNr}`);
            element4.innerHTML = '<player-box style="display: flex;" player="player4"></player-box>';
            console.log('player4', player4);
          break;
          case 'player5' : 
            window.player5 = Object.create(playerProto);
            player5.name = playerNr;
            player5.seated = true;
            let element5 = document.querySelector(`.${playerNr}`);
            element5.innerHTML = '<player-box style="display: flex;" player="player5"></player-box>';
            console.log('player5', player5);
          break;
        default:
        console.log(`Sorry, error`);
      }
      
     
      
    });
  //

 /* function showSeating(playerNumber = 1) {
      data.forEach((element) => {
        document.querySelector(`.player${playerNumber}-info-name`).innerHTML =  `Namn: ${element.name}<br>`;
        document.querySelector(`.player${playerNumber}-info-marks`).innerHTML = `Marker: ${element.marks}<br>`;
        document.querySelector(`.player${playerNumber}-info-chair`).innerHTML = `Stolnr: ${element.seat}<br>`;
        playerNumber++;
      });
    };
*/
  document.querySelector('.player-marks').innerHTML = `Spelare marker: ${currentPlayerPath.marks}`;
  document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerPath.pass}</i>, Lägga sig <i>${currentPlayerPath.fold}</i>`;
 
  /*let audio = new Audio('sound/background-sound.mp3');
  audio.volume = 0.1;
  audio.loop = true;
  audio.play();*/
  
  
  togglingCurrentPlayer(players);
  //document.querySelector('.board').innerHTML =  `Potten är: ${gamePot}`;
  
  //To highlight current player 
  let highlight = document.querySelector(`.${currentPlayer}`);
  highlight.classList.add('current-player-highlight');


  // Remove this function in production, used for testing diffrent players actions.
  function togglingCurrentPlayer(data) {
    var selectElement = document.querySelector('.player-switch-select');
    const dataToSelect = Object.keys(data);
    
    dataToSelect.forEach((item) => {
        const optionElement = document.createElement('option');
        optionElement.value = item;
        optionElement.text = item;
        selectElement.appendChild(optionElement);
    });
   
    selectElement.addEventListener('change', function() {
      let choosenPlayer = selectElement.options[selectElement.selectedIndex].value;
      let highlight = document.querySelector(`.${currentPlayer}`);
      highlight.classList.remove('current-player-highlight');
      currentPlayer = choosenPlayer;
      console.log('current player after chose',currentPlayer);
      let highlight2 = document.querySelector(`.${currentPlayer}`);
      highlight2.classList.add('current-player-highlight');
      console.log('currentPlayer', currentPlayer);
    });
   
  };
  //

  // Player Betting
  document.querySelector('.js-player-bet').addEventListener('click', function () {
    let audioBetting = new Audio('sound/betting.mp3');
    animateMarker(currentPlayer);
    audioBetting.play();
    let sliderValue = Number(slider.value);
    currentPlayerPath.bet.unshift(sliderValue);
    currentPlayerPath.marks -= slider.value;
    gamePot += currentPlayerPath.bet[0];
    
    let customEvent = new CustomEvent("gameEvent", {detail: `Player ${currentPlayer} bets ${sliderValue}`, bubbles: true, cancelable: true });
    document.querySelector('.js-player-bet').dispatchEvent(customEvent);

    document.querySelector('.player-marks').innerHTML = `Spelare marker: ${currentPlayerPath.marks}`; 
    //document.querySelector('.board').innerHTML =  `Potten är: ${gamePot}`;
    document.querySelector(`.${currentPlayer}-info-marks`).innerHTML =  `Marker: ${currentPlayerPath.marks}<br>`
  });
  //


  // Player Passing
  document.querySelector('.js-player-pass').addEventListener('click', function () {
    let audioPass = new Audio('sound/pass.mp3');
    audioPass.play();
    data[0].pass = true;

     let customEvent = new CustomEvent("gameEvent", {detail: `Player ${currentPlayer} passes ${currentPlayerPath.pass}`, bubbles: true, cancelable: true });
    document.querySelector('.js-player-bet').dispatchEvent(customEvent);

    document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerPath.pass}</i>, Lägga sig <i>${currentPlayerPath.fold}</i>`;
  });
  //


  // Player Fold
  document.querySelector('.js-player-fold').addEventListener('click', function () {
    let audioFold = new Audio('sound/fold.mp3');
    audioFold.play();
    currentPlayerPath.fold = true;

    let customEvent = new CustomEvent("gameEvent", {detail: `Player ${currentPlayer} folds ${currentPlayerPath.fold}`, bubbles: true, cancelable: true });
    document.querySelector('.js-player-bet').dispatchEvent(customEvent);

    document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerPath.pass}</i>, Lägga sig <i>${currentPlayerPath.fold}</i>`;
  });
  //


  // Player betting slider
  const slider = document.querySelector('.bet-slider');
  const output = document.querySelector('.bet-slider-output');
  output.innerHTML = slider.value;
  slider.addEventListener('input', sliderOutput);
  
  function sliderOutput() {
    console.log('slideroutput running');
    output.innerHTML = slider.value;
    document.querySelector('.player-marks').innerHTML = `Spelare marker: ${currentPlayerPath.marks}`; 
  };
  //

  // Admin activate question
  const getQButton = document.querySelector('.question-button');
  const getQNr = document.querySelector('#get-question-nr');
  getQButton.addEventListener('click', function (){
    askQuestion(getQNr.value);
  });
  //


  // Mark animation, several animations needed due to players diffrent positions.
  // Look into if you can have target goal cordinates instead.
  const animationMark = [
  { 
    transform: 'translateX(1px) rotate(4deg)', 
    transformOrigin: 'center', 
    filter: 'blur(8px)', 
    opacity: 0.6 
    },
    { 
      transform: 'translateX(300px) rotate(360deg)',
      transformOrigin: 'center',
      filter: 'blur(0)',
      opacity: 1 
    }
  ];

  const animationMarkRightSide = [
  { 
    transform: 'translateX(1px) rotate(4deg)', 
    transformOrigin: 'center', 
    filter: 'blur(8px)', 
    opacity: 0.6 
    },
    { 
      transform: 'translateX(-300px) rotate(360deg)',
      transformOrigin: 'center',
      filter: 'blur(0)',
      opacity: 1 
    }
  ];

  const animationMarkDownSide = [
  { 
    transform: 'translateY(1px) rotate(4deg)', 
    transformOrigin: 'center', 
    filter: 'blur(8px)', 
    opacity: 0.6 
    },
    { 
      transform: 'translateY(-300px) rotate(360deg)',
      transformOrigin: 'center',
      filter: 'blur(0)',
      opacity: 1 
    }
  ];

  const optionsMark = {
    iterations: 1,
    iterationStart: 0,
    delay: 0,
    endDelay: 0,
    duration: 700,
    fill: 'forwards',
    easing: 'ease-out',
  }

function animateMarker(currentPlayer) {
  switch (currentPlayer) {
  case 'player1':
  case 'player2':
    let element  = document.querySelector(`.img-mark-${currentPlayer}`);
    element.animate(animationMark,optionsMark)
    /*console.log('element', element);
    let target = element.cloneNode(true);
    console.log('target', target);
    let targetElement = document.querySelector(`.mark-${currentPlayer}`);
    targetElement.prepend(target); 
    target.animate(animationMark,optionsMark);*/
    
    break;
  case 'player3':
  case 'player4':
    document.querySelector(`.img-mark-${currentPlayer}`).animate (animationMarkRightSide,optionsMark);
    break;
  case 'player5':
    document.querySelector(`.img-mark-${currentPlayer}`).animate (animationMarkDownSide,optionsMark);
    break;
  default:
    console.log('Sorry, no player mark found');
  }
};
//
 
 // Main game logic
  await seating(data);
  await firstBet(data, gamePot); // this "betting" is handle by system not players
  await askQuestion(1);
  await wait();
  await askQuestion(2);
  await betting(0);
  await askQuestion(3);
  await wait();
  await askQuestion(4);
  await betting(1);
  await endGame(currentPlayerPath);
};
//

// According to spec players need pay 50 coins before seated, todo: make this funtion here.

async function seating(data) {
  return new Promise((resolve) => { //maybe dont need to return this, todo: look it up.
    let element = document.querySelector(`.${currentPlayer}`);
    addEventListener('click', function(event){
      element.classList.add('player-seated');
      console.log('seating event target', event.target);
    });

    /*var playerNumber = 1;
    data.forEach((item) => {
      document.querySelector(`.player${playerNumber}-info-name`).innerHTML =  `Namn: ${item.name}<br>`;
      document.querySelector(`.player${playerNumber}-info-marks`).innerHTML = `Marker: ${item.marks}<br>`;
      item.seated = true;
      playerNumber++;
    });*/
    if (allSeated) {resolve();};
    
  });
};


async function firstBet(data, gamePot) {
  
  return new Promise((resolve) => {
    
    data.forEach((item) => {
        item.marks -= 10;
        gamePot += 10;
        item.bet.push(10);
    });
    console.log('firstbet running');
     let testDT = document.querySelector('.player1-info-marks');
     console.log('testDT',testDT);
    document.querySelector(`.player2-info-marks`).innerHTML = `Marker: ${data[1].marks}<br>`;
    document.querySelector(`.player3-info-marks`).innerHTML = `Marker: ${data[2].marks}<br>`;
    document.querySelector(`.player4-info-marks`).innerHTML = `Marker: ${data[3].marks}<br>`;
    document.querySelector(`.player5-info-marks`).innerHTML = `Marker: ${data[4].marks}<br>`;
    //document.querySelector('.board').innerHTML =  `Potten är: ${gamePot}`;
    
    //Uncomment line belove to get game loop going again.
    //resolve();
  }); 
};


async function askQuestion(nr) {
  let currentQuestion = questions[`question${nr}`];
  return new Promise((resolve) => {
    console.log('currentQuestion: ', currentQuestion);
    countDown(3, currentQuestion, () => resolve()); 
    let questionSound = new Audio('sound/question.mp3');
    questionSound.volume = 0.1;
    questionSound.play();
    createQuestionForm(currentQuestion);
    let element = document.querySelector('#game-form');
    element.addEventListener('change', function() {
      playerChoice();
    });
  });
};


function timeout(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
};


async function wait() {
    document.querySelector('.game-wait').innerHTML = 'Snart kommer en ny fråga ...';
    await timeout(3000);
    document.querySelector('.game-wait').innerHTML = '';
};


async function betting(turn, currentPlayer) {
  return new Promise((resolve) => {
    let p1 = 100;
    let p2 = 200;
    resolve();
  });
};


async function endGame(currentPlayerPath) {
  return new Promise((resolve) => {
    let p1 = currentPlayerPath.bet; 
    let p1b = p1.reduce((a,b)=>a+b);
    let p2 = [400, 200];
    let p2b = p2.reduce((a,b)=>a+b);
    resolve();
  });
};


</script>
</html>
