<!DOCTYPE html>
<html>
<head>
    <title>The sheriff</title>
    <meta charset="UTF-8">
    <meta lang="se-SV">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Bungee|Manrope&display=swap" rel="stylesheet">
    <link href="main.css" rel="stylesheet">
</head>


<body id="sheriff-game">
  <main>
    <div class="main-game-grid">
        <div class="game-log"></div>
        <div class="game-board-wrapper">
          <div class="game-board">
            <player-box class="player1" player="player1"></player-box>
            <div class="game-questions"></div>
            <div class="board"></div>
            <player-box class="player4" player="player4"></player-box>
            <player-box class="player2" player="player2"></player-box>
            <player-box class="player3" player="player3"></player-box>
            <player-box class="player5" player="player5"></player-box>
          </div>
      </div>
        <player-controls class="player-input-wrapper"></player-controls>
      </div>
  </main>
</body>


<script type="module">
import {playerBox} from './modules/player.js';
import {questions} from './modules/questions.js';
import {createQuestionForm} from './modules/createquestionform.js';
import {countDown} from './modules/countdown.js';
import {playerChoice} from './modules/playerchoice.js';
import {players} from './modules/players.js';
import {controls} from './modules/controls.js';

window.onload = game();

async function game() {
  
  var data = Object.values(players);
  var gamePot = 0;
  var currentPlayer = 'player1';
  var currentPlayerNr = 1;
  var currentPlayerPath = data[0];
  var seatedPlayers = ['player1','player2']; // not in use right now
 
  // Custom event, logs game events
  document.addEventListener("gameEvent", function(event) {
    let time = new Date(); 
    let timeMin = time.getMinutes();
    let timeSec = time.getSeconds();
    //time.toLocaleDateString();
    document.querySelector('.game-log').insertAdjacentHTML('afterbegin', `${timeMin}:${timeSec} - ${event.detail}<br>`);
  });

  function showSeating(playerNumber = 1) {
      data.forEach((element) => {
        document.querySelector(`.player${playerNumber}-info-name`).innerHTML =  `Namn: ${element.name}<br>`;
        document.querySelector(`.player${playerNumber}-info-marks`).innerHTML = `Marker: ${element.marks}<br>`;
        document.querySelector(`.player${playerNumber}-info-chair`).innerHTML = `Stolnr: ${element.seat}<br>`;
        playerNumber++;
      });
    };

  document.querySelector('.player-marks').innerHTML = `Spelare marker: ${currentPlayerPath.marks}`;
  document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerPath.pass}</i>, Lägga sig <i>${currentPlayerPath.fold}</i>`;
 
  /*let audio = new Audio('sound/background-sound.mp3');
  audio.volume = 0.1;
  audio.loop = true;
  audio.play();*/
  
  
  togglingCurrentPlayer(players);
  //document.querySelector('.board').innerHTML =  `Potten är: ${gamePot}`;
  
  //To highlight current player 
  let highlight = document.querySelector(`.${currentPlayer}`);
  highlight.classList.add('current-player-highlight');


  // Remove this function in production, used for testing diffrent players actions.
  function togglingCurrentPlayer(data) {
    var selectElement = document.querySelector('.player-switch-select');
    const dataToSelect = Object.keys(data);
    
    dataToSelect.forEach((item) => {
        const optionElement = document.createElement('option');
        optionElement.value = item;
        optionElement.text = item;
        selectElement.appendChild(optionElement);
    });
   
    selectElement.addEventListener('change', function() {
      let choosenPlayer = selectElement.options[selectElement.selectedIndex].value;
      let highlight = document.querySelector(`.${currentPlayer}`);
      highlight.classList.remove('current-player-highlight');
      currentPlayer = choosenPlayer;
      console.log('current player after chose',currentPlayer);
      let highlight2 = document.querySelector(`.${currentPlayer}`);
      highlight2.classList.add('current-player-highlight');
      console.log('currentPlayer', currentPlayer);
    });
   
  };
  //

  // Player Betting
  document.querySelector('.js-player-bet').addEventListener('click', function () {
    let audioBetting = new Audio('sound/betting.mp3');
    animateMarker(currentPlayer);
    audioBetting.play();
    let sliderValue = Number(slider.value);
    currentPlayerPath.bet.unshift(sliderValue);
    currentPlayerPath.marks -= slider.value;
    gamePot += currentPlayerPath.bet[0];
    
    let customEvent = new CustomEvent("gameEvent", {detail: `Player ${currentPlayer} bets ${sliderValue}`, bubbles: true, cancelable: true });
    document.querySelector('.js-player-bet').dispatchEvent(customEvent);

    document.querySelector('.player-marks').innerHTML = `Spelare marker: ${currentPlayerPath.marks}`; 
    //document.querySelector('.board').innerHTML =  `Potten är: ${gamePot}`;
    document.querySelector(`.${currentPlayer}-info-marks`).innerHTML =  `Marker: ${currentPlayerPath.marks}<br>`
  });
  //


  // Player Passing
  document.querySelector('.js-player-pass').addEventListener('click', function () {
    let audioPass = new Audio('sound/pass.mp3');
    audioPass.play();
    data[0].pass = true;

     let customEvent = new CustomEvent("gameEvent", {detail: `Player ${currentPlayer} passes ${currentPlayerPath.pass}`, bubbles: true, cancelable: true });
    document.querySelector('.js-player-bet').dispatchEvent(customEvent);

    document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerPath.pass}</i>, Lägga sig <i>${currentPlayerPath.fold}</i>`;
  });
  //


  // Player Fold
  document.querySelector('.js-player-fold').addEventListener('click', function () {
    let audioFold = new Audio('sound/fold.mp3');
    audioFold.play();
    currentPlayerPath.fold = true;

    let customEvent = new CustomEvent("gameEvent", {detail: `Player ${currentPlayer} folds ${currentPlayerPath.fold}`, bubbles: true, cancelable: true });
    document.querySelector('.js-player-bet').dispatchEvent(customEvent);

    document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerPath.pass}</i>, Lägga sig <i>${currentPlayerPath.fold}</i>`;
  });
  //


  // Player betting slider
  const slider = document.querySelector('.bet-slider');
  const output = document.querySelector('.bet-slider-output');
  output.innerHTML = slider.value;
  slider.addEventListener('input', sliderOutput);
  
  function sliderOutput() {
    console.log('slideroutput running');
    output.innerHTML = slider.value;
    document.querySelector('.player-marks').innerHTML = `Spelare marker: ${currentPlayerPath.marks}`; 
  };
  //

  // Admin activate question
  const getQButton = document.querySelector('.question-button');
  const getQNr = document.querySelector('#get-question-nr');
  getQButton.addEventListener('click', function (){
    askQuestion(getQNr.value);
  });
  //


  // Mark animation, several animations needed due to players diffrent positions.
  // Look into if you can have target goal cordinates instead.
  const animationMark = [
  { 
    transform: 'translateX(1px) rotate(4deg)', 
    transformOrigin: 'center', 
    filter: 'blur(8px)', 
    opacity: 0.6 
    },
    { 
      transform: 'translateX(300px) rotate(360deg)',
      transformOrigin: 'center',
      filter: 'blur(0)',
      opacity: 1 
    }
  ];

  const animationMarkRightSide = [
  { 
    transform: 'translateX(1px) rotate(4deg)', 
    transformOrigin: 'center', 
    filter: 'blur(8px)', 
    opacity: 0.6 
    },
    { 
      transform: 'translateX(-300px) rotate(360deg)',
      transformOrigin: 'center',
      filter: 'blur(0)',
      opacity: 1 
    }
  ];

  const animationMarkDownSide = [
  { 
    transform: 'translateY(1px) rotate(4deg)', 
    transformOrigin: 'center', 
    filter: 'blur(8px)', 
    opacity: 0.6 
    },
    { 
      transform: 'translateY(-300px) rotate(360deg)',
      transformOrigin: 'center',
      filter: 'blur(0)',
      opacity: 1 
    }
  ];

  const optionsMark = {
    iterations: 1,
    iterationStart: 0,
    delay: 0,
    endDelay: 0,
    duration: 700,
    fill: 'forwards',
    easing: 'ease-out',
  }

function animateMarker(currentPlayer) {
  switch (currentPlayer) {
  case 'player1':
  case 'player2':
    let element  = document.querySelector(`.img-mark-${currentPlayer}`);
    element.animate(animationMark,optionsMark)
    /*console.log('element', element);
    let target = element.cloneNode(true);
    console.log('target', target);
    let targetElement = document.querySelector(`.mark-${currentPlayer}`);
    targetElement.prepend(target); 
    target.animate(animationMark,optionsMark);*/
    
    break;
  case 'player3':
  case 'player4':
    document.querySelector(`.img-mark-${currentPlayer}`).animate (animationMarkRightSide,optionsMark);
    break;
  case 'player5':
    document.querySelector(`.img-mark-${currentPlayer}`).animate (animationMarkDownSide,optionsMark);
    break;
  default:
    console.log('Sorry, no player mark found');
  }
};
//
 
 // Main game logic
  await seating(data);
  await firstBet(data, gamePot); // this "betting" is handle by system not players
  await askQuestion(1);
  await wait();
  await askQuestion(2);
  await betting(0);
  await askQuestion(3);
  await wait();
  await askQuestion(4);
  await betting(1);
  await endGame(currentPlayerPath);
};
//

// According to spec players need pay 50 coins before seated, todo: make this funtion here.

async function seating(data) {
  return new Promise((resolve) => { //maybe dont need to return this, todo: look it up.
    var playerNumber = 1;
    data.forEach((item) => {
      document.querySelector(`.player${playerNumber}-info-name`).innerHTML =  `Namn: ${item.name}<br>`;
      document.querySelector(`.player${playerNumber}-info-marks`).innerHTML = `Marker: ${item.marks}<br>`;
      item.seated = true;
      playerNumber++;
    });
    resolve()
  });
};


async function firstBet(data, gamePot) {
  return new Promise((resolve) => {
    data.forEach((item) => {
        item.marks -= 10;
        gamePot += 10;
        item.bet.push(10);
    });
    document.querySelector(`.player1-info-marks`).innerHTML = `Marker: ${data[0].marks}<br>`;
    document.querySelector(`.player2-info-marks`).innerHTML = `Marker: ${data[1].marks}<br>`;
    document.querySelector(`.player3-info-marks`).innerHTML = `Marker: ${data[2].marks}<br>`;
    document.querySelector(`.player4-info-marks`).innerHTML = `Marker: ${data[3].marks}<br>`;
    document.querySelector(`.player4-info-marks`).innerHTML = `Marker: ${data[4].marks}<br>`;
    //document.querySelector('.board').innerHTML =  `Potten är: ${gamePot}`;
    
    //Uncomment line belove to get game loop going again.
    //resolve();
  }); 
};


async function askQuestion(nr) {
  let currentQuestion = questions[`question${nr}`];
  return new Promise((resolve) => {
    console.log('currentQuestion: ', currentQuestion);
    countDown(3, currentQuestion, () => resolve()); 
    let questionSound = new Audio('sound/question.mp3');
    questionSound.volume = 0.1;
    questionSound.play();
    createQuestionForm(currentQuestion);
    let element = document.querySelector('#game-form');
    element.addEventListener('change', function() {
      playerChoice();
    });
  });
};


function timeout(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
};


async function wait() {
    document.querySelector('.game-wait').innerHTML = 'Snart kommer en ny fråga ...';
    await timeout(3000);
    document.querySelector('.game-wait').innerHTML = '';
};


async function betting(turn, currentPlayer) {
  return new Promise((resolve) => {
    let p1 = 100;
    let p2 = 200;
    resolve();
  });
};


async function endGame(currentPlayerPath) {
  return new Promise((resolve) => {
    let p1 = currentPlayerPath.bet; 
    let p1b = p1.reduce((a,b)=>a+b);
    let p2 = [400, 200];
    let p2b = p2.reduce((a,b)=>a+b);
    resolve();
  });
};


</script>
</html>
