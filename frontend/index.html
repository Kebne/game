<!DOCTYPE html>
<html>
<head>
    <title>The sheriff</title>
    <meta charset="UTF-8">
    <meta lang="se-SV">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Bungee|Manrope&display=swap" rel="stylesheet">
    <link href="main.css" rel="stylesheet">
</head>


<body id="sheriff-game">
  <main>
    <div class="main-game-grid">
        <div class="game-log"></div>
        <div class="game-board-wrapper">
          <div class="game-board">
            <div class="player1"><img class="img-full-width" id="player1" src="images/empty-chair.png"></div>
            <div class="game-questions"></div>
            <div class="board"></div>
            <div class="player4"><img class="img-full-width" id="player4" src="images/empty-chair.png"></div>
            <div class="player2"><img class="img-full-width" id="player2" src="images/empty-chair.png"></div>
            <div class="player3"><img class="img-full-width" id="player3" src="images/empty-chair.png"></div>
            <div class="player5"><img class="img-full-width" id="player5" src="images/empty-chair.png"></div>
          </div>
      </div>
        <player-controls class="player-input-wrapper"></player-controls>
      </div>
  </main>
</body>


<script type="module">
import {playerBox} from './modules/player.js';
import {questions} from './modules/questions.js';
import {createQuestionForm} from './modules/createquestionform.js';
import {countDown} from './modules/countdown.js';
//import {playerChoice} from './modules/playerchoice.js';
//import {players} from './modules/players.js';
import {controls} from './modules/controls.js';
import {animateMarker} from './modules/animations.js';

const playerProto = {
   marks: 1000,
   name: 'John Doe',
   seat: 1,
   pass: false,
   bet: [],
   fold: false,
   answers: [],
   rightAnswerNr: 0,
   seated: false,
 };

var players = {
   player1: Object.create(playerProto),
   player2: Object.create(playerProto),
   player3: Object.create(playerProto),
   player4: Object.create(playerProto),
   player5: Object.create(playerProto), 
 };


var currentPlayer = 'player1';
var data = Object.values(players);
var gamePot = 0;
var currentPlayerNr = 1;
var currentPlayerPath = data[0];
var seatedPlayers = []; // not in use right now, maybe implement as async await player1, player2 etc
var allSeated = false;


// This is needed to be globally function se we can reapply event listner when players left
function createPlayer() { 
    let wichPlayer = event.target.id;
    let playerNr = String(wichPlayer);
    let audioSeated = new Audio('sound/seated.mp3');
    audioSeated.play();
    players[playerNr]['seated'] = true;
    seatedPlayers.push(playerNr);
    players[playerNr]['marks'] = 500;
    let playerName = players[playerNr]['name'];
    let playerMark = players[playerNr]['marks'];
    let element1 = document.querySelector(`.${playerNr}`);
    element1.innerHTML = `<player-box player="${playerNr}"></player-box>`;
    document.querySelector(`.${playerNr}-info-name`).innerHTML = `Namn: ${playerName }`;
    document.querySelector(`.${playerNr}-info-marks`).innerHTML = `Marker: ${playerMark}`;
    document.querySelector('.board').innerHTML =  `Potten är: ${gamePot}`;
};

 

window.onload = game();
async function game() {
  // Custom event, logs game events
  document.addEventListener("gameEvent", function(event) {
    let time = new Date(); 
    let timeMin = time.getMinutes();
    let timeSec = time.getSeconds();
    //time.toLocaleDateString();
    document.querySelector('.game-log').insertAdjacentHTML('afterbegin', `${timeMin}:${timeSec} - ${event.detail}<br>`);
  });

  const playerLeaveElement = document.querySelector('.game-board');
  document.addEventListener('click', function() {
    let whatElement = event.target;
    let getString = whatElement.className;
    let playerToSelectForLeaving = getString.replace('-leave', '');
    
    if(whatElement.nodeName == 'BUTTON') {
      const imgElement = document.createElement("img");
      imgElement.src = 'images/empty-chair.png';
      imgElement.id = playerToSelectForLeaving;
      imgElement.className = 'img-full-width';
      imgElement.addEventListener('click', createPlayer);
      document.querySelector(`.${playerToSelectForLeaving}`).innerHTML = '';
      document.querySelector(`.${playerToSelectForLeaving}`).appendChild(imgElement);
    };
    
  });
  

  document.querySelector('.player-marks').innerHTML = `Spelare marker: ${currentPlayerPath.marks}`;
  document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerPath.pass}</i>, Lägga sig <i>${currentPlayerPath.fold}</i>`;
   
  togglingCurrentPlayer(players);
  //document.querySelector('.board').innerHTML =  `Potten är: ${gamePot}`;
  
  //To highlight current player 
  let highlight = document.querySelector(`.${currentPlayer}`);
  highlight.classList.add('current-player-highlight');


  // Remove this function in production, used for testing diffrent players actions.
  function togglingCurrentPlayer(data) {
    
    var selectElement = document.querySelector('.player-switch-select');
    const dataToSelect = Object.keys(data);
    
    dataToSelect.forEach((item) => {
        const optionElement = document.createElement('option');
        optionElement.value = item;
        optionElement.text = item;
        selectElement.appendChild(optionElement);
    });
   
    selectElement.addEventListener('change', function() {
      let choosenPlayer = selectElement.options[selectElement.selectedIndex].value;
      let highlight = document.querySelector(`.${currentPlayer}`);
      highlight.classList.remove('current-player-highlight');
      currentPlayer = choosenPlayer;
      console.log('current player after chose',currentPlayer);
      let highlight2 = document.querySelector(`.${currentPlayer}`);
      highlight2.classList.add('current-player-highlight');
      console.log('currentPlayer', currentPlayer);
    });
   
  };
  //

  // Player Betting
  document.querySelector('.js-player-bet').addEventListener('click', function () {
    let audioBetting = new Audio('sound/betting.mp3');
    animateMarker(currentPlayer);
    audioBetting.play();
    let sliderValue = Number(slider.value);
    currentPlayerPath.bet.unshift(sliderValue);
    currentPlayerPath.marks -= slider.value;
    gamePot += currentPlayerPath.bet[0];
    
    let customEvent = new CustomEvent("gameEvent", {detail: `Spelare ${currentPlayer} bettar ${sliderValue}`, bubbles: true, cancelable: true });
    document.querySelector('.js-player-bet').dispatchEvent(customEvent);

    document.querySelector('.player-marks').innerHTML = `Spelare marker: ${currentPlayerPath.marks}`; 
    //document.querySelector('.board').innerHTML =  `Potten är: ${gamePot}`;
    document.querySelector(`.${currentPlayer}-info-marks`).innerHTML =  `Marker: ${currentPlayerPath.marks}<br>`
  });
  //


  // Player Passing
  document.querySelector('.js-player-pass').addEventListener('click', function () {
    let audioPass = new Audio('sound/pass.mp3');
    audioPass.play();
    data[0].pass = true;

     let customEvent = new CustomEvent("gameEvent", {detail: `Spalare ${currentPlayer} passar ${currentPlayerPath.pass}`, bubbles: true, cancelable: true });
    document.querySelector('.js-player-bet').dispatchEvent(customEvent);

    document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerPath.pass}</i>, Lägga sig <i>${currentPlayerPath.fold}</i>`;
  });
  //


  // Player Fold
  document.querySelector('.js-player-fold').addEventListener('click', function () {
    let audioFold = new Audio('sound/fold.mp3');
    audioFold.play();
    currentPlayerPath.fold = true;

    let customEvent = new CustomEvent("gameEvent", {detail: `Spelare ${currentPlayer} lägger sig ${currentPlayerPath.fold}`, bubbles: true, cancelable: true });
    document.querySelector('.js-player-bet').dispatchEvent(customEvent);

    document.querySelector('.player-status').innerHTML = `Pass: <i>${currentPlayerPath.pass}</i>, Lägga sig <i>${currentPlayerPath.fold}</i>`;
  });
  //


  // Player betting slider
  const slider = document.querySelector('.bet-slider');
  const output = document.querySelector('.bet-slider-output');
  output.innerHTML = slider.value;
  slider.addEventListener('input', sliderOutput);
  
  function sliderOutput() {
    console.log('slideroutput running');
    output.innerHTML = slider.value;
    document.querySelector('.player-marks').innerHTML = `Spelare marker: ${currentPlayerPath.marks}`; 
  };
  //

 

  // Admin activate question
  const getQButton = document.querySelector('.question-button');
  const getQNr = document.querySelector('#get-question-nr');
  getQButton.addEventListener('click', function() {
    askQuestion(getQNr.value);
  });
  //

  


 
 // Main game logic
  await seating();
  await firstBet(data, gamePot); // this "betting" is handle by system not players
  await askQuestion(1);
  await wait();
  await askQuestion(2);
  await betting(0);
  await askQuestion(3);
  await wait();
  await askQuestion(4);
  await betting(1);
  await endGame(currentPlayerPath);
}; // end game function
//



async function seating() {
  return new Promise((resolve) => { 
 

  document.querySelector('#player1').addEventListener('click', createPlayer);
  document.querySelector('#player2').addEventListener('click', createPlayer);
  document.querySelector('#player3').addEventListener('click', createPlayer);
  document.querySelector('#player4').addEventListener('click', createPlayer);
  document.querySelector('#player5').addEventListener('click', createPlayer);
  


    // Player ready'
  document.querySelector('.js-player-ready').addEventListener('click', function () {
    let audioReady = new Audio('sound/start.mp3'); // lets go sound in here
    audioReady.play();
    currentPlayerPath.ready = true;

    // Maybe not the best way to show the graphical mark but it works, feel free to refactor this
    let getHiddenClass = document.querySelectorAll('.mark-wrapper-display-none');
    getHiddenClass.forEach(item => item.classList.toggle('mark-wrapper-display-none'));

    let customEvent = new CustomEvent("gameEvent", {detail: `Spelare ${currentPlayer} redo`, bubbles: true, cancelable: true });
    document.querySelector('.js-player-ready').dispatchEvent(customEvent);

    resolve();
  });
  //

  
  });
};


async function firstBet(data, gamePot) {
  console.log('firstbet now running');
  return new Promise((resolve) => {
    
  data.forEach((item) => {
        console.log('item', item.name);
        item.marks -= 10;
        gamePot += 10;
        item.bet.push(10);
    });
    
    seatedPlayers.forEach((item) => {
    let playerMark = players[item]['marks'];
    document.querySelector(`.${item}-info-marks`).innerHTML = `Marker: ${playerMark}`;   
    });
  
    document.querySelector('.board').innerHTML =  `Potten är: ${gamePot}`;

    let customEvent = new CustomEvent("gameEvent", {detail: `Alla spelare har gjort första bettet`, bubbles: true, cancelable: true });
    document.querySelector('.js-player-ready').dispatchEvent(customEvent);
    
    //Uncomment line belove to get game loop going again.
    resolve();
  }); 
};


async function askQuestion(nr) {
  let currentQuestion = questions[`question${nr}`];
  return new Promise((resolve) => {
    console.log('currentQuestion: ', currentQuestion);
    countDown(10, currentQuestion, () => resolve()); 
    let questionSound = new Audio('sound/question.mp3');
    questionSound.volume = 0.1;
    questionSound.play();
    createQuestionForm(currentQuestion);

    let element1 = document.querySelector('#game-question-button1');
    element1.addEventListener('click', function() {
      let audioReady = new Audio('sound/start.mp3'); // lets go sound in here
      audioReady.play();
      let customEvent = new CustomEvent("gameEvent", {detail: `Spelare ${currentPlayer}  svarade: ${element1.innerHTML}`, bubbles: true, cancelable: true });
      document.querySelector('#game-question-button1').dispatchEvent(customEvent); 
    });
    let element2 = document.querySelector('#game-question-button2');
    element2.addEventListener('click', function() {
      let audioReady = new Audio('sound/start.mp3'); // lets go sound in here
      audioReady.play();
      let customEvent = new CustomEvent("gameEvent", {detail: `Spelare ${currentPlayer}  svarade: ${element2.innerHTML}`, bubbles: true, cancelable: true });
      document.querySelector('#game-question-button1').dispatchEvent(customEvent);
    });
    let element3 = document.querySelector('#game-question-button3');
    element3.addEventListener('click', function() {
      let audioReady = new Audio('sound/start.mp3'); // lets go sound in here
      audioReady.play();
      let customEvent = new CustomEvent("gameEvent", {detail: `Spelare ${currentPlayer}  svarade: ${element3.innerHTML}`, bubbles: true, cancelable: true });
      document.querySelector('#game-question-button1').dispatchEvent(customEvent); 
    });
    
  });
};



function timeout(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
};


async function wait() {
    document.querySelector('.game-wait').innerHTML = 'Snart kommer en ny fråga ...';
    await timeout(3000);
    document.querySelector('.game-wait').innerHTML = '';
};


async function betting(turn, currentPlayer) {
  return new Promise((resolve) => {
    let p1 = 100;
    let p2 = 200;
    resolve();
  });
};


async function endGame(currentPlayerPath) {
  return new Promise((resolve) => {
    let p1 = currentPlayerPath.bet; 
    let p1b = p1.reduce((a,b)=>a+b);
    let p2 = [400, 200];
    let p2b = p2.reduce((a,b)=>a+b);
    resolve();
  });
};


</script>
</html>
